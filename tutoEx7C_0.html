<html>
    <head>
        <title>ol3 - Ex7C - interaction with WMS GetFeatureInfo + vector loading</title>
        <script type="text/javascript" src="js/config.js"></script>
        <script type="text/javascript">
            var map, vectors, wmsLayer;
            $(document).ready(function () {

                var wmsSource = new ol.source.ImageWMS({
                    url: unWMS,
                    params: {
                        VERSION: "1.1.1",
                        LAYERS: 'World',
                        FORMAT: 'image/png',
                        STYLES: 'polygon'
                    }
                });

                map = new ol.Map({
                    target: 'map',
                    view: new ol.View({
                        center: ol.proj.transform([6.7, 46.7], 'EPSG:4326', 'EPSG:3857'),
                        zoom: 4
                    })
                });
                
                // Create/Add a WMS baselayer
                wmsLayer = new ol.layer.Image({
                    source: wmsSource
                });
                map.addLayer(wmsLayer);

                // Create/add an empty vector layer
                vectors = new ol.layer.Vector({
                    source: new ol.source.Vector()
                });
                map.addLayer(vectors);
                
                map.on('singleclick', function (evt) {
                    var url = wmsSource.getGetFeatureInfoUrl(
                            evt.coordinate,
                            map.getView().getResolution(),
                            "EPSG:3857",
                            {
                                INFO_FORMAT: "application/json",
                                FEATURE_COUNT: 1
                            }
                    );
                    if (url)
                        getFeatureInfo(url);
                });

                function getFeatureInfo(url) {
                    var url2 = encodeURIComponent(url);
                    var request = $.ajax({
                        url: "php/proxy2.php?url=" + url2,
                        dataType: "json",
                    });

                    request.done(function (data) {
                        decoder = new ol.format.GeoJSON();
                        features = decoder.readFeatures(data, {
                            dataProjection: "EPSG:4326",
                            featureProjection: "EPSG:3857"
                        });
                        console.log(features);

                        if (features.length > 0) {
                            vectors.getSource().clear();
                            vectors.getSource().addFeatures(features);
                            $("#info").html(features[0].get("terr_name"));
                        }
                    });

                    request.fail(function (jqXHR, textStatus) {
                        alert("Request failed: " + textStatus);
                    });
                }
            });
        </script>

        <style type="text/css">
            #map {
                width: 100%;
                height: 100%;
            }
            #info {
                position: absolute;
                top: 20px;
                left: 50px;
                background-color: white;
                border: solid gray 1px;
                padding: 5px;
                font-size: smaller;
                z-index: 1000000000;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="info">Click on the map to get feature info</div>
    </body>
</html>