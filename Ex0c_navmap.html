<!DOCTYPE html>
<html>
    <head>
        <title>Navmap - Feature info control</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <script src="https://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>       
        <script type="text/javascript">
            var blWMS = "http://demo.boundlessgeo.com/geoserver/wms";
            var ctrx, ctry, x, y;
            var zoom = 2;
            var pan = 10;

            $(document).ready(function () {
                // situation initiale
                ctrx = 0;
                ctry = 0;
                x = 180;
                y = 90;

                doGetMapRequests();
                $("span").click(navmap);
                $("img").click(doGetFeatureInfo);
            });

            function navmap(e) {
                switch ($(this).first().attr("id")) {
                    case "westBtn":
                        ctrx = ctrx - pan;
                        break;
                    case "northBtn":
                        ctry = ctry + pan;
                        break;
                    case "eastBtn":
                        ctrx = ctrx + pan;
                        break;
                    case "southBtn":
                        ctry = ctry - pan;
                        break;
                    case "zinBtn":
                        x = x / zoom;
                        y = y / zoom;
                        break;
                    case "zoutBtn":
                        x = x * zoom;
                        y = y * zoom;
                        break;
                    case "lakesBtn":
                        $("#layer2").toggle();
                        break;
                }
                doGetMapRequests();
            }

            function doGetMapRequests() {
                minx = ctrx - x;
                maxx = ctrx + x;
                miny = ctry - y;
                maxy = ctry + y;

                bbox = minx + "," + miny + "," + maxx + "," + maxy;
                console.log(bbox);

                params1 = {
                    service: "WMS",
                    version: "1.1.0",
                    request: "GetMap",
                    layers: "ne_10m_admin_0_countries",
                    styles: "",
                    bbox: bbox,
                    width: 800,
                    height: 400,
                    srs: "EPSG:4326",
                    format: "image/png"
                };

                request = blWMS + "?" + jQuery.param(params1);
                $("#layer1").attr("src", request);

                params2 = {
                    service: "WMS",
                    version: "1.1.0",
                    request: "GetMap",
                    layers: "ne_10m_lakes",
                    styles: "",
                    bbox: bbox,
                    width: 800,
                    height: 400,
                    srs: "EPSG:4326",
                    format: "image/png",
                    transparent: true
                };

                request = blWMS + "?" + jQuery.param(params2);
                $("#layer2").attr("src", request);
            }

            function doGetFeatureInfo(e) {
                minx = ctrx - x;
                maxx = ctrx + x;
                miny = ctry - y;
                maxy = ctry + y;

                bbox = minx + "," + miny + "," + maxx + "," + maxy;
                console.log(e);

                params3 = {
                    service: "WMS",
                    version: "1.1.0",
                    request: "GetFeatureInfo",
                    bbox: bbox,
                    srs: "EPSG:4326",
                    height: 400,
                    width: 800,
                    layers: "ne_10m_admin_0_countries",
                    format: "image/png",
                    styles: "",
                    query_layers: "ne_10m_admin_0_countries",
                    x: e.clientX,
                    y: e.clientY,
                    info_format: "application/json"
                }

                $.ajax({
                    url: blWMS,
                    data: params3,
                    dataType: "json",
                    success: function (response) {
                        info = response.features[0].properties.admin + " / " + response.features[0].properties.pop_est.toLocaleString() + " inhab.";
                        $("#info").html(info);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("The request has failed: " + textStatus);
                    }
                });
            }
        </script>

        <style type="text/css">
            body {
                margin: 0;
                background-color: lightgrey;
            }

            span {
                font-weight: bold;
            }

            #map img {
                width: 800;
                height: 400;
                position: absolute;
            }

            #ctrl {
                position: absolute;
                left: 820px;                
            }
        </style>        

    </head>
    <body>
        <div id="ctrl">
            <p>PAN: <span id="eastBtn">East</span> - <span id="northBtn">North</span> - <span id="westBtn">West</span> - <span id="southBtn">South</span></p>
            <p>ZOOM: <span id="zinBtn">In</span> - <span id="zoutBtn">Out</span></p>
            <p>OVERLAY: <span id="lakesBtn">Lakes (on/off)</span></p>
            <p>INFO: <span id="info"></span></p>
        </div>        
        <div id="map">
            <img id="layer1" src="">
            <img id="layer2" src="">          
        </div>
    </body>
</html>
